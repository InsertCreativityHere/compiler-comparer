This repository exists solely to hold `compiler-comparer.py`,
a python script I wrote to automatically compare the code generated by different versions of the Slice compilers.

As someone who spends alot of time modifying the innards of these compilers,
it will be nice to have this tool as a safety net: to check if I accidentally introduce regressions,
and so I can more easily see _exactly_ how my changes to the code affect the code generation.


### Examples

Check if the code generated by `slice2cpp` has changed in the last 3 commits.
The script will build the Slice compilers on the commits: `HEAD~3`, `HEAD~2`, `HEAD~1`, and `HEAD~0`,
and for each commit, it runs `slice2cpp` over all `*.ice` files in the top-level `slice` directory.
```
python compiler-comparer.py --back-track=3 -c=slice2cpp --parallel ./slice
```

Compare the generated code between the `main` branch and the `add-metadata-validation` branch.
The script will run _all_ available Slice compilers since none were specified,
but they will only be run over the two files: `./slice/Ice/Locator.ice` and `./slice/Ice/Router.ice`
```
python compiler-comparer.py -b=main -b=add-metadata-validation --parallel ./slice/Ice/Locator.ice ./slice/Ice/Router.ice
```

Compare the code generated by `slice2java` and `slice2cs` between the `main` branch and the `9100d41` commit.
The script will generate code for _every single_ `.ice` file in the repository.
The directory structure of the generated code is preserved, so there is no risk of file-name collisions.
```
python compiler-comparer.py --branch=main --branch=9100d41 --compiler=slice2java --compiler=slice2cs --parallel
```


### Usage

```
Usage: python compiler-comparer.py [options] [slice_files...]
```

`slice_files` should be separated by spaces and can be either individual files or directories.
If a file is provided it is passed directly to the Slice compilers (and should end with `.ice`).
If a directory is provided, this script will recursively search for all files ending with `.ice` within the directory and compile them.


```
Options:
-c, --compiler     Specifies a slice compiler that this script should run over Slice files.
                   This should be the bare name of the compiler, without any file extension.
                   For example: `--compiler=slice2java` tells the script to only run `slice2java`.

                   It is valid to provide multiple compilers; this script will run them in the
                   order they are provided.

                   If no compilers are specified, this script will automatically use _all_
                   the available Slice compilers on the current platform.


-b, --branch       Specifies which branches the script should checkout before building.
                   Actually this can be any 'treeish' including branch names, commit IDs, and tags.
                   For example: `--branch=main --branch=9100d41` tells the script to check a branch
                   named `main` and a commit with an ID of `9100d41`.

                   It is valid to provide multiple branches; this script will check them out and
                   build them in the order they are provided.

                   If no branches are specified, this script will automatically use `HEAD`.


--back-track       Instructs the script to use back-tracking.
                   Instead of checking out specific branches/commits, the script will start at
                   `HEAD~N` and build every commit (in order) until it's reached back to `HEAD`.
                   For example: `--back-track=12` tells the script to check the last 12 commits.

                   If `--back-track` is specified, it is invalid to also provide specific branches
                   with `--branch`. Only one of these options may be used at a time.


--proj-path        Specifies the project file path that should be used to build the compilers.
                   It shouldn't be necessary to set this if you're inside the repository,
                   the script should be able to find `cpp/msbuild/ice.proj` automatically.
                   But if it can't, or you want to build with a different project, this exists.
                   For example: `--proj-path="D:/Code/Workspace/ice/cpp/msbuild/ice.proj"`


--compilers-path   Specifies where the compilers will be built, so the script can find them.
                   It shouldn't be necessary to set this if you're inside the repository,
                   the script should be able to locate them based on the current platform.
                   But if it can't, or you want to use a different set of compilers, this exists?

                   If provided, the path should be relative to the root of the repository.
                   For example: `--compilers-path="cpp/bin"` is the expected path on unix systems.


--python-path      This is probably useless. I should probably remove it.


--parallel         Instructs the script to build and run the Slice compilers in parallel.
                   You probably want this turned on.

                   Note: 'slice2java', 'slice2py', and 'slice2matlab' are always run serially due
                   to race conditions in how they generate directories and shared files.
                   But all other compilers will be run in parallel, even if used alongside one of
                   the above, and the building of the compilers themselves will also be in parallel.
```


### Compilation Failures

If a failure occurs while building the Slice compilers, the script proceeds no further.
Instead of generating code, it will generate a single file named `BUILD_FAILURE` which
contains information about what caused the build to fail.
After generating this special file, the script continues to the next branch/commit like usual.

If a failure occurs while running a Slice compiler, the script simply ignores it.
No code is generated, and no information about the failure is noted, but we proceed on to the
next Slice file as if nothing happened.
Note that the Slice compilers will still print any warnings/errors to `stdout`,
so they're still visible to users, but we do not store them in a file like build failures.


### Debugging

At the top of this script there is a hardcoded bool:
```
DEBUGGING = False;
```
Setting this to true will enable debug mode, which causes the script to output information about its own state,
but will also cause it to forward `stdout` to the current terminal sessions for any commands it runs, allowing you
to see the real-time output as it builds and runs the Slice compilers.

Note that `stderr` is _always_ forwarded to the current terminal session. So any warnings/errors produced by the build
will always be visible while running this script.
